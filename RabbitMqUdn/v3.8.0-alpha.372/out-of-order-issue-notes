# Previously delivered messages delivered again out-of-order issues
Have three terminal windows opened

## STEP 1 - Create 3 node cluster and quorum queue with rep factor of 3 and leader on rabbitmq3

Terminal 1
$ cd automated
$ bash setup-test-run.sh 3 3.8
$ cd cluster
$ python create-quorum-queue.py rabbitmq1 Test1 3 rabbitmq3

## STEP 2 - See out-of-order delivery of messages to previously delivered messages
Terminal 2 (client directory)
$ python publish.py --node rabbitmq3 --queue Test1 --msgs 1000 --msg-type sequence
direct

Terminal 3 (client directory)
$ python simple-consumer.py --queue Test1 --node rabbitmq3
[see 1000 messages in order]
ctrl C to stop script
$ python simple-consumer.py --queue Test1 --node rabbitmq3
[see lots of previously delivered messages, totally out of order]
ctrl C to stop script
$ python simple-consumer.py --queue Test1 --node rabbitmq3
[see lots of previously delivered messages, totally out of order]
ctrl C to stop script
python simple-consumer.py --queue Test1 --node rabbitmq3
[no messages]
ctrl C to stop script

## Control test - same publisher and consumer with HA queue
### STEP 1 - Create queue on existing cluster
terminal 1 (cluster directory)
$ python create-ha-queue.py rabbitmq1 Test2 rabbitmq3

### STEP 2 - See no delivery of messages of previously delivered messages
Terminal 2 (client directory)
$ python publish.py --node rabbitmq3 --queue Test1 --msgs 1000 --msg-type sequence
direct

Terminal 3 (client directory)
$ python simple-consumer.py --queue Test1 --node rabbitmq3
[see 1000 messages in order]
ctrl C to stop script
$ python simple-consumer.py --queue Test1 --node rabbitmq3
[no messages]
ctrl C to stop script

## Additional notes
I have tested with with 100, 1000 and 10000 messages. It only occurs in the 1000+ message tests.
With 1000 messages, it is usually the fourth execution that yields 0 messages.
With 10000 messages, it is usually the sixth execution that yields 0 messages.



## Example results of quorum queue test:
(venv-rabbit) [jack@localhost client]$ python publish.py --node rabbitmq3 --queue Test1 --msgs 1000 --msg-type sequence
direct
Will publish to exchange  and routing key Test1
Attempting to connect to 172.26.0.4
Connection opened: <SelectConnection OPEN socket=('172.26.0.1', 50768)->('172.26.0.4', 5672) params=<URLParameters host=172.26.0.4 port=5672 virtual_host=/ ssl=False>>
Channel opened, publishing to commence
Pos acks: 235 Neg acks: 0 Undeliverable: 0
Pos acks: 401 Neg acks: 0 Undeliverable: 0
Pos acks: 531 Neg acks: 0 Undeliverable: 0
Pos acks: 619 Neg acks: 0 Undeliverable: 0
Pos acks: 709 Neg acks: 0 Undeliverable: 0
Pos acks: 855 Neg acks: 0 Undeliverable: 0
Pos acks: 934 Neg acks: 0 Undeliverable: 0
Pos acks: 1000 Neg acks: 0 Undeliverable: 0
Final Count => Pos acks: 1000 Neg acks: 0 Undeliverable: 0


(venv-rabbit) [jack@localhost client]$ python simple-consumer.py --queue Test1 --node rabbitmq2
Consuming queue: Test1
b'a=1'
b'a=2'
b'a=3'
b'a=4'
b'a=5'
b'a=6'
b'a=7'
b'a=8'
b'a=9'
b'a=10'
...
b'a=934'
b'a=935'
b'a=936'
b'a=937'
b'a=938'
b'a=939'
b'a=940'
b'a=941'
b'a=942'
b'a=943'
b'a=944'
b'a=945'
b'a=946'
b'a=947'
b'a=948'
b'a=949'
b'a=950'
b'a=951'
b'a=952'
b'a=953'
b'a=954'
b'a=955'
b'a=956'
b'a=957'
b'a=958'
b'a=959'
b'a=960'
b'a=961'
b'a=962'
b'a=963'
b'a=964'
b'a=965'
b'a=966'
b'a=967'
b'a=968'
b'a=969'
b'a=970'
b'a=971'
b'a=972'
b'a=973'
b'a=974'
b'a=975'
b'a=976'
b'a=977'
b'a=978'
b'a=979'
b'a=980'
b'a=981'
b'a=982'
b'a=983'
b'a=984'
b'a=985'
b'a=986'
b'a=987'
b'a=988'
b'a=989'
b'a=990'
b'a=991'
b'a=992'
b'a=993'
b'a=994'
b'a=995'
b'a=996'
b'a=997'
b'a=998'
b'a=999'
b'a=1000'
^C(venv-rabbit) [jack@localhost client]$ python simple-consumer.py --queue Test1 --node rabbitmq1
Consuming queue: Test1
b'a=742'
b'a=446'
b'a=551'
b'a=646'
b'a=847'
b'a=737'
b'a=701'
b'a=970'
b'a=846'
b'a=454'
b'a=885'
b'a=458'
b'a=602'
b'a=899'
b'a=711'
b'a=628'
b'a=875'
b'a=977'
b'a=548'
b'a=957'
b'a=945'
b'a=353'
b'a=841'
b'a=393'
b'a=978'
b'a=854'
b'a=667'
b'a=367'
b'a=384'
b'a=972'
b'a=358'
b'a=431'
b'a=622'
b'a=828'
b'a=902'
b'a=376'
b'a=684'
b'a=557'
b'a=552'
b'a=887'
b'a=886'
b'a=687'
b'a=870'
b'a=660'
b'a=620'
b'a=434'
b'a=859'
b'a=982'
b'a=558'
b'a=966'
b'a=979'
b'a=730'
b'a=375'
b'a=873'
b'a=543'
b'a=826'
b'a=631'
b'a=382'
b'a=582'
b'a=532'
b'a=901'
b'a=365'
b'a=383'
b'a=712'
b'a=704'
b'a=836'
b'a=542'
b'a=715'
b'a=844'
b'a=849'
b'a=536'
b'a=354'
b'a=818'
b'a=861'
b'a=621'
b'a=696'
b'a=869'
b'a=448'
b'a=724'
b'a=736'
b'a=546'
b'a=590'
b'a=441'
b'a=538'
b'a=692'
b'a=949'
b'a=833'
b'a=600'
b'a=589'
b'a=370'
b'a=374'
b'a=391'
b'a=440'
b'a=950'
b'a=651'
b'a=550'
b'a=671'
b'a=626'
b'a=435'
b'a=971'
b'a=834'
b'a=987'
b'a=541'
b'a=606'
b'a=459'
b'a=624'
b'a=905'
b'a=819'
b'a=673'
b'a=964'
b'a=457'
b'a=983'
b'a=906'
b'a=663'
b'a=357'
b'a=723'
b'a=461'
b'a=533'
b'a=883'
b'a=702'
b'a=534'
b'a=664'
b'a=850'
b'a=682'
b'a=658'
b'a=831'
b'a=462'
b'a=361'
b'a=616'
b'a=623'
b'a=980'
b'a=392'
b'a=379'
b'a=555'
b'a=649'
b'a=784'
b'a=856'
b'a=537'
b'a=632'
b'a=583'
b'a=614'
b'a=707'
b'a=386'
b'a=556'
b'a=981'
b'a=953'
b'a=709'
b'a=871'
b'a=824'
b'a=862'
b'a=645'
b'a=731'
b'a=588'
b'a=881'
b'a=691'
b'a=364'
b'a=634'
b'a=553'
b'a=735'
b'a=612'
b'a=668'
b'a=368'
b'a=581'
b'a=892'
b'a=674'
b'a=656'
b'a=615'
b'a=838'
b'a=975'
b'a=725'
b'a=825'
b'a=679'
b'a=734'
b'a=989'
b'a=740'
b'a=699'
b'a=429'
b'a=545'
b'a=447'
b'a=955'
b'a=657'
b'a=633'
b'a=443'
b'a=823'
b'a=713'
b'a=385'
b'a=438'
b'a=973'
b'a=356'
b'a=587'
b'a=733'
b'a=960'
b'a=539'
b'a=535'
b'a=372'
b'a=993'
b'a=882'
b'a=829'
b'a=840'
b'a=544'
b'a=693'
b'a=666'
b'a=689'
b'a=549'
b'a=394'
b'a=884'
b'a=675'
b'a=720'
b'a=994'
b'a=865'
b'a=531'
b'a=860'
b'a=661'
b'a=900'
b'a=586'
b'a=585'
b'a=990'
b'a=835'
b'a=721'
b'a=652'
b'a=449'
b'a=433'
b'a=371'
b'a=363'
b'a=992'
b'a=681'
b'a=878'
b'a=395'
b'a=669'
b'a=580'
b'a=593'
b'a=967'
b'a=635'
b'a=609'
b'a=703'
b'a=944'
b'a=741'
b'a=991'
b'a=697'
b'a=710'
b'a=654'
b'a=678'
b'a=637'
b'a=378'
b'a=727'
b'a=718'
b'a=830'
b'a=641'
b'a=427'
b'a=672'
b'a=455'
b'a=717'
b'a=450'
b'a=866'
b'a=888'
b'a=599'
b'a=954'
b'a=355'
b'a=863'
b'a=947'
b'a=894'
b'a=362'
b'a=618'
b'a=380'
b'a=603'
b'a=904'
b'a=597'
b'a=607'
b'a=719'
b'a=445'
b'a=827'
b'a=845'
b'a=387'
b'a=946'
b'a=451'
b'a=729'
b'a=436'
b'a=611'
b'a=592'
b'a=986'
b'a=853'
b'a=605'
b'a=843'
b'a=442'
b'a=962'
b'a=821'
b'a=456'
b'a=732'
b'a=965'
b'a=969'
b'a=630'
b'a=638'
b'a=688'
b'a=837'
b'a=359'
b'a=650'
b'a=452'
b'a=604'
b'a=848'
b'a=369'
b'a=988'
b'a=690'
b'a=685'
b'a=976'
b'a=540'
b'a=951'
b'a=864'
b'a=591'
b'a=437'
b'a=876'
b'a=855'
b'a=858'
b'a=683'
b'a=389'
b'a=619'
b'a=640'
b'a=596'
b'a=629'
b'a=952'
b'a=377'
b'a=890'
b'a=598'
b'a=786'
b'a=714'
b'a=868'
b'a=644'
b'a=968'
b'a=554'
b'a=700'
b'a=985'
b'a=381'
b'a=613'
b'a=956'
b'a=877'
b'a=439'
b'a=617'
b'a=665'
b'a=584'
b'a=895'
b'a=896'
b'a=662'
b'a=676'
b'a=874'
b'a=984'
b'a=639'
b'a=453'
b'a=872'
b'a=820'
b'a=595'
b'a=547'
b'a=698'
b'a=891'
b'a=653'
b'a=893'
b'a=716'
b'a=432'
b'a=608'
b'a=460'
b'a=706'
b'a=897'
b'a=898'
b'a=655'
b'a=390'
b'a=680'
b'a=579'
b'a=694'
b'a=366'
b'a=739'
b'a=722'
b'a=610'
b'a=857'
b'a=601'
b'a=625'
b'a=428'
b'a=880'
b'a=529'
b'a=708'
b'a=594'
b'a=903'
b'a=677'
b'a=738'
b'a=867'
b'a=839'
b'a=642'
b'a=373'
b'a=643'
b'a=726'
b'a=360'
b'a=659'
b'a=785'
b'a=670'
b'a=444'
b'a=851'
b'a=959'
b'a=842'
b'a=958'
b'a=695'
b'a=822'
b'a=974'
b'a=852'
b'a=648'
b'a=728'
b'a=963'
b'a=647'
b'a=686'
b'a=832'
b'a=430'
b'a=388'
b'a=627'
b'a=530'
b'a=636'
b'a=961'
b'a=889'
b'a=948'
b'a=879'
b'a=705'
b'a=463'
^C(venv-rabbit) [jack@localhost client]$ python simple-consumer.py --queue Test1 --node rabbitmq3
Consuming queue: Test1
b'a=876'
b'a=705'
b'a=858'
b'a=650'
b'a=874'
b'a=961'
b'a=832'
b'a=962'
b'a=653'
b'a=460'
b'a=728'
b'a=604'
b'a=369'
b'a=437'
b'a=688'
b'a=630'
b'a=676'
b'a=388'
b'a=547'
b'a=893'
b'a=896'
b'a=948'
b'a=690'
b'a=638'
b'a=647'
b'a=879'
b'a=855'
b'a=608'
b'a=430'
b'a=821'
b'a=963'
b'a=889'
b'a=432'
b'a=698'
b'a=359'
b'a=540'
b'a=595'
b'a=988'
b'a=627'
b'a=895'
b'a=716'
b'a=662'
b'a=463'
b'a=442'
b'a=685'
b'a=530'
b'a=706'
b'a=837'
b'a=820'
b'a=848'
b'a=591'
b'a=453'
b'a=951'
b'a=554'
b'a=456'
b'a=872'
b'a=976'
b'a=686'
b'a=965'
b'a=864'
b'a=891'
b'a=636'
b'a=969'
b'a=897'
b'a=732'
b'a=639'
b'a=984'
b'a=452'
